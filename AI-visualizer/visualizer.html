<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lem-in Visualizer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }
      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }
      .controls {
        padding: 25px;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
      }
      .button-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
      }
      button {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn-secondary:hover {
        background: #5a6268;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-success:hover {
        background: #218838;
      }
      .speed-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .speed-control input {
        width: 150px;
      }
      .stats {
        display: flex;
        gap: 20px;
        padding: 20px 25px;
        background: #e9ecef;
        flex-wrap: wrap;
      }
      .stat-item {
        background: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .stat-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 5px;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #495057;
      }
      #visualization {
        padding: 40px;
        min-height: 500px;
        position: relative;
      }
      svg {
        width: 100%;
        height: 600px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        background: #fafafa;
      }
      .room {
        cursor: pointer;
        transition: all 0.3s;
      }
      .room circle {
        fill: #fff;
        stroke: #667eea;
        stroke-width: 3;
      }
      .room.start circle {
        fill: #28a745;
        stroke: #1e7e34;
      }
      .room.end circle {
        fill: #dc3545;
        stroke: #bd2130;
      }
      .room:hover circle {
        stroke-width: 5;
        filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
      }
      .room text {
        fill: #495057;
        font-size: 14px;
        font-weight: bold;
        pointer-events: none;
      }
      .path {
        fill: none;
        stroke: #adb5bd;
        stroke-width: 2;
        opacity: 0.6;
      }
      .ant {
        transition: all 0.5s ease-in-out;
      }
      .ant circle {
        fill: #ff6b6b;
        stroke: #c92a2a;
        stroke-width: 2;
      }
      .ant text {
        fill: white;
        font-size: 12px;
        font-weight: bold;
        text-anchor: middle;
        dominant-baseline: middle;
      }
      .loading {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üêú Lem-in Visualizer</h1>
        <p>Visualisation automatique du d√©placement des fourmis</p>
      </div>

      <div class="controls">
        <div class="button-group">
          <button class="btn-primary" onclick="startAnimation()">
            ‚ñ∂Ô∏è D√©marrer
          </button>
          <button class="btn-secondary" onclick="pauseAnimation()">
            ‚è∏Ô∏è Pause
          </button>
          <button class="btn-success" onclick="resumeAnimation()">
            ‚ñ∂Ô∏è Reprendre
          </button>
          <button class="btn-secondary" onclick="resetAnimation()">
            üîÑ Reset
          </button>

          <div class="speed-control">
            <label for="speedRange">Vitesse:</label>
            <input
              type="range"
              id="speedRange"
              min="0.1"
              max="2"
              step="0.1"
              value="1"
            />
            <span id="speedValue">1x</span>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-label">Tour actuel</div>
          <div class="stat-value" id="currentTurn">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Total tours</div>
          <div class="stat-value" id="totalTurns">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Fourmis actives</div>
          <div class="stat-value" id="activeAnts">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Fourmis arriv√©es</div>
          <div class="stat-value" id="finishedAnts">0</div>
        </div>
      </div>

      <div id="visualization">
        <div class="loading">Chargement des donn√©es...</div>
        <svg id="graphSvg"></svg>
      </div>
    </div>

    <script>
      let turns = [];
      let currentTurnIndex = 0;
      let animationInterval = null;
      let isPaused = false;
      let speed = 1;
      let rooms = {};
      let paths = [];
      let antsPositions = {};
      let totalAnts = 0;
      let finishedAnts = 0;

      window.onload = async function () {
        try {
          const roomsResponse = await fetch("/api/rooms");
          const roomsData = await roomsResponse.json();

          const movesResponse = await fetch("/api/moves");
          const movesDataResponse = await movesResponse.json();

          if (movesDataResponse.moves) {
            turns = movesDataResponse.moves
              .split("\n")
              .filter((line) => line.trim());

            if (roomsData && Object.keys(roomsData).length > 0) {
              loadRoomsWithCoordinates(roomsData);
            }

            createGraph();
            document.querySelector(".loading").style.display = "none";
            document.getElementById("totalTurns").textContent = turns.length;
          }
        } catch (error) {
          console.error("Erreur de chargement:", error);
          document.querySelector(".loading").textContent =
            "Erreur: " + error.message;
        }
      };

      document.getElementById("speedRange").addEventListener("input", (e) => {
        speed = parseFloat(e.target.value);
        document.getElementById("speedValue").textContent =
          speed.toFixed(1) + "x";
        if (animationInterval) {
          clearInterval(animationInterval);
          animationInterval = setInterval(nextTurn, 1000 / speed);
        }
      });

      function loadRoomsWithCoordinates(roomsData) {
        rooms = {};
        paths = [];
        antsPositions = {};
        totalAnts = 0;
        finishedAnts = 0;

        const connections = new Set();

        let minX = Infinity,
          maxX = -Infinity;
        let minY = Infinity,
          maxY = -Infinity;

        Object.values(roomsData).forEach((room) => {
          if (room.x < minX) minX = room.x;
          if (room.x > maxX) maxX = room.x;
          if (room.y < minY) minY = room.y;
          if (room.y > maxY) maxY = room.y;
        });

        const svg = document.getElementById("graphSvg");
        const width = svg.clientWidth;
        const height = svg.clientHeight;
        const padding = 80;

        Object.entries(roomsData).forEach(([name, room]) => {
          const normalizedX =
            padding +
            ((room.x - minX) / (maxX - minX || 1)) * (width - 2 * padding);
          const normalizedY =
            padding +
            ((room.y - minY) / (maxY - minY || 1)) * (height - 2 * padding);

          rooms[name] = {
            x: normalizedX,
            y: normalizedY,
            name: name,
            type: room.type,
          };
        });

        turns.forEach((turn) => {
          const moves = turn.split(" ");
          moves.forEach((move) => {
            const [ant, room] = move.split("-");

            const antNum = parseInt(ant.substring(1));
            if (antNum > totalAnts) totalAnts = antNum;

            if (!antsPositions[ant]) {
              antsPositions[ant] = { history: ["start"], current: "start" };
            }

            const prevRoom = antsPositions[ant].current;
            antsPositions[ant].history.push(room);
            antsPositions[ant].current = room;

            if (
              prevRoom &&
              prevRoom !== room &&
              rooms[prevRoom] &&
              rooms[room]
            ) {
              const conn = [prevRoom, room].sort().join("-");
              connections.add(conn);
            }
          });
        });

        connections.forEach((conn) => {
          const [room1, room2] = conn.split("-");
          if (rooms[room1] && rooms[room2]) {
            paths.push({ from: room1, to: room2 });
          }
        });

        document.getElementById("totalTurns").textContent = turns.length;
      }

      function createGraph() {
        const svg = document.getElementById("graphSvg");
        svg.innerHTML = "";

        paths.forEach((path) => {
          const from = rooms[path.from];
          const to = rooms[path.to];
          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line"
          );
          line.setAttribute("x1", from.x);
          line.setAttribute("y1", from.y);
          line.setAttribute("x2", to.x);
          line.setAttribute("y2", to.y);
          line.setAttribute("class", "path");
          svg.appendChild(line);
        });

        Object.values(rooms).forEach((room) => {
          const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
          g.setAttribute("class", `room ${room.type}`);

          const circle = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "circle"
          );
          circle.setAttribute("cx", room.x);
          circle.setAttribute("cy", room.y);
          circle.setAttribute("r", 25);
          g.appendChild(circle);

          const text = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text"
          );
          text.setAttribute("x", room.x);
          text.setAttribute("y", room.y + 45);
          text.setAttribute("text-anchor", "middle");
          text.textContent = room.name;
          g.appendChild(text);

          svg.appendChild(g);
        });
      }

      function startAnimation() {
        currentTurnIndex = 0;
        finishedAnts = 0;
        isPaused = false;
        document.getElementById("currentTurn").textContent = "0";
        document.getElementById("finishedAnts").textContent = "0";

        if (animationInterval) clearInterval(animationInterval);
        animationInterval = setInterval(nextTurn, 1000 / speed);
      }

      function nextTurn() {
        if (isPaused || currentTurnIndex >= turns.length) {
          if (currentTurnIndex >= turns.length) {
            clearInterval(animationInterval);
          }
          return;
        }

        const turn = turns[currentTurnIndex];
        const moves = turn.split(" ");

        const svg = document.getElementById("graphSvg");
        document.querySelectorAll(".ant").forEach((ant) => ant.remove());

        const activeAnts = new Set();

        moves.forEach((move) => {
          const [ant, room] = move.split("-");
          activeAnts.add(ant);

          if (rooms[room]) {
            const g = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "g"
            );
            g.setAttribute("class", "ant");

            const circle = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "circle"
            );
            circle.setAttribute("cx", rooms[room].x);
            circle.setAttribute("cy", rooms[room].y);
            circle.setAttribute("r", 15);
            g.appendChild(circle);

            const text = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text"
            );
            text.setAttribute("x", rooms[room].x);
            text.setAttribute("y", rooms[room].y);
            text.textContent = ant.substring(1);
            g.appendChild(text);

            svg.appendChild(g);

            if (rooms[room].type === "end") {
              finishedAnts++;
            }
          }
        });

        currentTurnIndex++;
        document.getElementById("currentTurn").textContent = currentTurnIndex;
        document.getElementById("activeAnts").textContent = activeAnts.size;
        document.getElementById("finishedAnts").textContent = finishedAnts;
      }

      function pauseAnimation() {
        isPaused = true;
      }

      function resumeAnimation() {
        isPaused = false;
      }

      function resetAnimation() {
        if (animationInterval) {
          clearInterval(animationInterval);
          animationInterval = null;
        }
        isPaused = false;
        currentTurnIndex = 0;
        finishedAnts = 0;
        document.getElementById("currentTurn").textContent = "0";
        document.getElementById("activeAnts").textContent = "0";
        document.getElementById("finishedAnts").textContent = "0";

        const svg = document.getElementById("graphSvg");
        document.querySelectorAll(".ant").forEach((ant) => ant.remove());
      }
    </script>
  </body>
</html>
